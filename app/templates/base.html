<!doctype html>
<html class="no-js" lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>{{ _('Music Zone') }}</title>
	<meta name="description" content="">
	<meta name="robots" content="noindex, follow" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="robots" content="noindex, follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Https -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <!-- Live stream css -->
    <link rel="stylesheet" href="../static/css/style_live.css">
	<!-- Place favicon.ico in the root directory -->
	<link rel="shortcut icon" type="image/x-icon" href="../static/img/favicon.ico">
    <!--All Css Here-->
    
    <!-- Bootstrap CSS-->
	<link rel="stylesheet" href="../static/css/bootstrap.min.css">
	<!-- Linearicon CSS-->
    <link rel="stylesheet" href="../static/css/linearicons.min.css">
    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="../static/css/font-awesome.min.css">

	<!-- Animate CSS-->
	<link rel="stylesheet" href="../static/css/animate.css">
	<!-- Owl Carousel CSS-->
	<link rel="stylesheet" href="../static/css/owl.carousel.min.css">
	<!-- Slick CSS-->
	<link rel="stylesheet" href="../static/css/slick.css">
	<!-- Meanmenu CSS-->
	<link rel="stylesheet" href="../static/css/meanmenu.min.css">
	<!-- Easyzoom CSS-->
	<link rel="stylesheet" href="../static/css/easyzoom.css">
	<!-- Venobox CSS-->
	<link rel="stylesheet" href="../static/css/venobox.css">
	<!-- Jquery Ui CSS-->
	<link rel="stylesheet" href="../static/css/jquery-ui.css">
	<!-- Nice Select CSS-->
	<link rel="stylesheet" href="../static/css/nice-select.css">
	<!-- Style CSS -->
	<link rel="stylesheet" href="../static/css/style.css">
	<!-- Responsive CSS -->
	<link rel="stylesheet" href="../static/css/responsive.css">
	<!-- Modernizr Js -->
	<script src="../static/js/vendor/modernizr-2.8.3.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!--Google Login-->
{#    <meta name="google-signin-scope" content="profile email">#}
{#    <meta name="google-signin-client_id" content="739725862362-ulv61obr6dqhfl4l5ponl5g6vrpf1r8e.apps.googleusercontent.com">#}
{#    <script src="https://apis.google.com/js/platform.js?onload=onLoad" async defer></script>#}
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        function onLoad() {
          gapi.load('auth2', function() {
            gapi.auth2.init();
          });
        }

        function googleSignOut() {
            window.location.href = "{{ url_for('auth.logout') }}";
        }
    </script>
</head>
<body>
	<div class="wrapper">
		<!--Header Area Start-->
		<header>
		    <div class="header-container">
                <!-- The header of index-3 will cause overlapping in other pages, thus applying the head class of shop
		        <div class="header-area header-absolute header-sticky pt-30 pb-30">
                    <div class="container-fluid pl-50 pr-50">   -->
                <div class="header-area header-sticky pt-30 pb-30" style="background: linear-gradient(to bottom, #c9c0bd, #eeeae5)">
                    <div class="container">
                        <div class="row">
                            <!--Header Logo Start-->
                            <div class="col-lg-3 col-md-3">
                                <div class="logo-area" style="width: auto">
                                    <!--a href="index.html"-->
                                    <a href="{{ url_for('main.index') }}">
                                        <img src="../static/storage/music-zone-logo.png" alt="" style="width: 150px; height: auto">
                                    </a>
                                </div>
                            </div>
                            <!--Header Logo End-->


                            <!--Header Menu And Mini Cart Start-->
                            <div class="col-lg-9 col-md-9 text-lg-right">
                                <!--Main Menu Area Start-->
                                <div class="header-menu">
                                    <nav>
                                        <ul class="main-menu">
                                            <li><a href="{{ url_for('main.index') }}">{{ _('Home') }}</a></li>
                                            <li><a href="{{ url_for('main.shop', c="all") }}">{{ _('Shop') }}</a></li>
                                        </ul>
                                    </nav>
                                </div>
                                <!--Main Menu Area End-->
                                <!--Header Option Start-->
                                <div class="header-option">
                                    <div class="mini-cart-search">
                                        <div class="mini-cart">
                                            {% if current_user.is_authenticated %}
                                                <a href="{{ url_for('main.cart') }}">
                                                    <span class="cart-icon">
                                                       <span class="cart-quantity" id="mini_cart_count">{{ ncart }}</span>
                                                    </span>
                                                    <span class="cart-title">{{ _('Your Cart') }} <br><strong id="mini_cart_price">${{ mcp.product_price }}</strong></span>
                                                </a>
                                                <!--Cart Dropdown Start-->
                                                <div class="cart-dropdown" style="display: none">
                                                    <ul id="mini_cart_list">
                                                        {% for cart_item in mcd %}
                                                            <li class="single-cart-item">
                                                                  <div class="cart-img">
                                                                      <a href="{{ url_for('main.single_product', p=cart_item.product_id) }}"><img src="{{ cart_item.product_img }}" alt="" style="width: 80px; height: 80px"></a>
                                                                  </div>
                                                                  <div class="cart-content">
                                                                      <h5 class="product-name"><a href="{{ url_for('main.single_product', p=cart_item.product_id) }}">{{ cart_item.product_name }}</a></h5>
                                                                      <span class="cart-price">{{ cart_item.product_num }} Ã— ${{ cart_item.product_price }}</span>
                                                                  </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                    <p class="cart-subtotal"><strong>{{ _('Subtotal') }}:</strong><span class="float-right" id="mini_cart_subtotal">${{ mcp.product_price }}</span></p>
                                                    <p class="cart-btn">
                                                        <!--Update required!!!-->
                                                        <a href="{{ url_for('main.cart') }}">{{ _('View all') }}</a>
                                                    </p>
                                                </div>
                                            {% else %}
                                                <a>
                                                    <span class="cart-icon"></span>
                                                    <span class="cart-title">{{ _('Your Cart') }} <br><strong>$--</strong></span>
                                                </a>
                                            {% endif %}
                                           <!--Cart Dropdown End-->
                                        </div>
                                        <div class="header-search">
                                            <div class="search-box">
                                                <a href="#"><i class="fa fa-search"></i></a>
                                                <div class="search-dropdown">
                                                    <form action="#">
                                                        <input name="search" id="content" placeholder="" value="Search product..." onblur="if(this.value===''){this.value='Search product...'}" onfocus="if(this.value==='Search product...'){this.value=''}" type="text">
                                                        <input type="text" style="display: none">
                                                        <button id="searchinput" type="button"><i class="fa fa-search"></i></button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="currency">
                                            <div class="currency-box">
                                                <a href="#"><i class="fa fa-th"></i></a>
                                                <div class="currency-dropdown">
                                                    <ul class="menu-top-menu">
                                                        <li>
                                                        {% if current_user.is_authenticated %}
                                                            <a href="{{ url_for('main.account', user_id=current_user.id ) }}">
                                                                <img src="{{ current_user.avatar_path }}" style="width: 30px; height: 30px; border-radius: 100%"  alt=""/>
                                                                {{ _('Profile') }}
                                                            </a>
                                                        {% else %}
                                                            <a href="{{ url_for('auth.login') }}">
                                                                <img src="../static/storage/avatars/non-login.png" style="width: 30px; height: 30px; border-radius: 100%"  alt=""/>
                                                                {{ _('Profile') }}
                                                            </a>
                                                        {% endif %}
                                                        </li>
                                                        <li><a href="{{ url_for('main.cart') }}">{{ _('Shopping Cart') }}</a></li>
                                                        <li><a href="{{ url_for('main.portfolio') }}">{{ _('Portfolio') }}</a></li>
                                                        <li><a href="{{ url_for('main.blog') }}">{{ _('Blog') }}</a></li>
                                                        <li><a href="{{ url_for('main.about') }}">{{ _('About Us') }}</a></li>
{#                                                        <li><a href="{{ url_for('main.contact') }}">{{ _('Contact Us') }}</a></li>#}
                                                        {% if current_user.is_authenticated %}
                                                            <li><a style="cursor: pointer" onclick="googleSignOut()">{{ _('Log Out') }}</a></li>
                                                        {% else %}
                                                            <li><a style="cursor: pointer" href="{{ url_for('auth.login') }}">{{ _('Log In') }}</a></li>
                                                        {% endif %}
                                                    </ul>
                                                    <div class="switcher">
                                                        <div class="language">
                                                            <span class="switcher-title">{{ _('Language') }}: </span>
                                                            <div class="switcher-menu">
                                                                <ul id="selected-language">
                                                                    {% if session['language'] %}
                                                                    <li><a href="#">{{ session['language'] }}</a>
                                                                        <ul class="switcher-dropdown">
                                                                            <li><a href="#" id="alternative-language">{{ session['alternative_language'] }}</a></li>
                                                                        </ul>
                                                                    </li>
                                                                    {% else %}
                                                                    <li><a href="#">English</a>
                                                                        <ul class="switcher-dropdown">
                                                                            <li><a href="#" id="alternative-language">Chinese</a></li>
                                                                        </ul>
                                                                    </li>
                                                                    {% endif %}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <!--Header Option End-->
                            </div>
                            <!--Header Menu And Mini Cart End-->
                        </div>
                        <div class="row">
                            <div class="col-12"> 
                                <!--Mobile Menu Area Start-->
                                <div class="mobile-menu d-lg-none"></div>
                                <!--Mobile Menu Area End-->
                            </div>
                        </div>
                    </div>

                    <div id="flash_messages">
                        {% with messages = get_flashed_messages() %}
                            {% if messages %}
                                {% for message in get_flashed_messages() %}
                                    <div class="alert alert-warning">
                                        <button type="button" class="close" data-dismiss="alert" style="margin-bottom: 0">&times;</button>
                                        {{ message }}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
		    </div>
		</header>

        <main>
            {% block content %}
                <!-- main content -->
            {% endblock %}
        </main>

        <!--Footer Area Start-->
		<footer>
		    <div class="footer-container">
		        <!--Footer Top Area Start-->
		        <div class="footer-top-area black-bg">
		            <div class="container">
		                <div class="row">
		                    <div class="col-lg-3 col-md-6">
		                        <!--Single Footer Widget Start-->
		                        <div class="single-footer-widget mb-40">
		                            <div class="footer-title">
		                                <h3>{{ _('My Account') }}</h3>
		                            </div>
		                            <ul class="link-widget">
		                                <li><a href="{{ url_for('main.about') }}">{{ _('About Us') }}</a></li>
		                                <li><a href="#">{{ _('Team Member') }}</a></li>
		                                <li><a href="#">{{ _('Career') }}</a></li>
		                                <li><a href="#">{{ _('Specials') }}</a></li>
		                                <li><a href="#">{{ _('Best sellers') }}</a></li>
		                                <li><a href="#">{{ _('Our stores') }}</a></li>
		                                <li><a href="{{ url_for('main.contact') }}">{{ _('Contact us') }}</a></li>
		                            </ul>
		                        </div>
		                        <!--Single Footer Widget End-->
		                    </div>
		                    <div class="col-lg-3 col-md-6">
		                        <!--Single Footer Widget Start-->
		                        <div class="single-footer-widget mb-40">
		                            <div class="footer-title">
		                                <h3>{{ _('Information') }}</h3>
		                            </div>
		                            <ul class="link-widget">
		                                <li><a href="{{ url_for('main.about') }}">{{ _('About Us') }}</a></li>
		                                <li><a href="{{ url_for('main.contact') }}">{{ _('Contact us') }}</a></li>
		                                <li><a href="#">{{ _('My orders') }}</a></li>
		                                <li><a href="#">{{ _('Terms & Conditions') }}</a></li>
		                                <li><a href="#">{{ _('Returns & Exchanges') }}</a></li>
		                                <li><a href="#">{{ _('Shipping & Delivery') }}</a></li>
		                                <li><a href="#">{{ _('Privacy Policy') }}</a></li>
		                            </ul>
		                        </div>
		                        <!--Single Footer Widget End-->
		                    </div>
		                    <div class="col-lg-3 col-md-6">
		                        <!--Single Footer Widget Start-->
		                        <div class="single-footer-widget mb-40">
		                            <div class="footer-title">
		                                <h3>{{ _('Quick Links') }}</h3>
		                            </div>
		                            <ul class="link-widget">
		                                <li><a href="#">{{ _('Support Center') }}</a></li>
		                                <li><a href="#">{{ _('Term & Conditions') }}</a></li>
		                                <li><a href="#">{{ _('Shipping') }}</a></li>
		                                <li><a href="#">{{ _('Privacy Policy') }}</a></li>
		                                <li><a href="#">{{ _('Help') }}</a></li>
		                                <li><a href="#">{{ _('Products Return') }}</a></li>
		                                <li><a href="{{ url_for('main.question') }}">{{ _('FAQS') }}</a></li>
		                            </ul>
		                        </div>
		                        <!--Single Footer Widget End-->
		                    </div>
		                    <div class="col-lg-3 col-md-6">
		                        <!--Single Footer Widget Start-->
		                        <div class="single-footer-widget mb-40">
		                            <div class="footer-title">
		                                <h3>{{ _('Categories') }}</h3>
		                            </div>
		                            <ul class="link-widget">
                                        {% for ca in catee %}
		                                <li><a href="{{ url_for('main.shop', c=ca) }}">{{ ca }}</a></li>
{#		                                <li><a href="#">{{ _('Piano') }}</a></li>#}
{#		                                <li><a href="#">{{ _('Stings') }}</a></li>#}
{#		                                <li><a href="#">{{ _('Saxophone') }}</a></li>#}
{#		                                <li><a href="#">{{ _('Woods') }}</a></li>#}
{#		                                <li><a href="#">{{ _('Brass') }}</a></li>#}
{#		                                <li><a href="#">{{ _('Drums') }}</a></li>#}
                                        {% endfor %}
		                            </ul>
		                        </div>
		                        <!--Single Footer Widget End-->
		                    </div>
		                </div>
		            </div>
		        </div>
		        <!--Footer Top Area End-->
		        <!--Footer Middle Area Start-->
		        <div class="footer-middle-area black-bg">
		            <div class="container">
		                <div class="row">
		                    <div class="col-lg-3 col-md-6">
		                        <!--Single Footer Widget Start-->
		                        <div class="single-footer-widget mb-30">
		                            <div class="footer-logo">
		                                <a href="{{ url_for('main.index') }}"><img src="../static/storage/music-zone-logo-dark.png" alt="" style="width: 150px; height: auto"></a>
		                            </div>
		                        </div>
		                        <!--Single Footer Widget End-->
		                    </div>
		                    <div class="col-lg-3 col-md-6">
		                        <!--Single Footer Widget Start-->
		                        <div class="single-footer-widget mb-30">
		                            <div class="footer-info">
		                                <div class="icon">
		                                    <i class="fa fa-home"></i>
		                                </div>
		                                <p>{{ _('Address : 100 Pingleyuan, Chaoyang District, Beijing 100124, China.') }}</p>
		                            </div>
		                        </div>
		                        <!--Single Footer Widget End-->
		                    </div>
		                    <div class="col-lg-3 col-md-6">
		                        <!--Single Footer Widget Start-->
		                        <div class="single-footer-widget mb-30">
		                            <div class="footer-info">
		                                <div class="icon">
		                                    <i class="fa fa-envelope-open-o"></i>
		                                </div>
		                                <p>{{ _('Email') }}: <br>info@email.com</p>
		                            </div>
		                        </div>
		                        <!--Single Footer Widget End-->
		                    </div>
		                    <div class="col-lg-3 col-md-6">
		                        <!--Single Footer Widget Start-->
		                        <div class="single-footer-widget mb-30">
		                            <div class="footer-info">
		                                <div class="icon">
		                                    <i class="fa fa-mobile"></i>
		                                </div>
		                                <p>{{ _('Phone') }}: <br>(+86) 13051702828</p>
		                            </div>
		                        </div>
		                        <!--Single Footer Widget End-->
		                    </div>
		                </div>
		            </div>
		        </div>
		        <!--Footer Middle Area End-->
		        <!--Footer Bottom Area Start-->
		        <div class="footer-bottom-area black-bg pt-50 pb-50">
		            <div class="container">
		                <div class="row">
		                    <div class="col-md-12">
                                <!--Footer Payment Start-->
		                        <div class="footer-payments-image">
		                            <img src="../static/img/payment/payment-icon.png" alt="">
		                        </div>
		                        <!--Footer Payment End-->
		                        <!--Footer Menu Start-->
		                        <div class="footer-menu text-center">
		                            <nav>
		                                <ul>
		                                    <li><a href="#">{{ _('Site Map') }}</a></li>
		                                    <li><a href="#">{{ _('Search Terms') }}</a></li>
		                                    <li><a href="#">{{ _('Advanced Search') }}</a></li>
		                                    <li><a href="#">{{ _('Orders and Returns') }}</a></li>
		                                    <li><a href="#">{{ _('Contact Us') }}</a></li>
		                                </ul>
		                            </nav>
		                        </div>
		                        <!--Footer Menu End-->
		                        <!--Footer Copyright Start-->
		                        <div class="footer-copyright">
		                            <p>{{ _('Copyright') }} Â© <a href="#">SEP2-7</a> {{ _('All Rights Reserved') }}</p>
		                        </div>
		                        <!--Footer Copyright End-->
		                    </div>
		                </div>
		            </div>
		        </div>
		        <!--Footer Bottom Area End-->
		    </div>
		</footer>
		<!--Footer Area End-->
	</div>
    <form action="{{ url_for('main.shop', c="search") }}" method="post" name="selectForm">
        <input type="hidden" id="searchselect" name="searchselect" value="">
        <button type="submit" id="basepass" class="btn btn-info" style="display: none">pass</button>
    </form>

    <div class="loader-wrapper">
      <span class="loader"><span class="loader-inner"></span></span>
    </div>


    <!--Fixed Component Start-->
    <img alt="agora-logo" src="../static/icon/agora-logo.png" style="width: 50px; height: 50px; position: fixed; bottom: 100px; right: 25px; cursor: pointer" id="open_liveroom">
    <!--Fixed Component End-->

    <!--Movable Component Start-->
    <div class="live_container" id="liveroom">
        <div class="live_left">
{#            <div class="live_left_top"></div>#}
            <div class="live_left_stream" id="stream">

            </div>
{#            <div class="live_left_bottom"></div>#}
        </div>
        <div class="live_right" id="live_right">
            <div class="live_right_top" id="live_right_top">
                <img alt="head" src="{{ current_user.avatar_path }}" class="live_right_top_img">
                <span class="live_right_top_name">{{ current_user.username }}</span>
                <i class="fa fa-sign-out online" style="float: right; margin-top: 15px; margin-right: 10px; cursor: pointer" id="leave_live"></i>
            </div>
            <div class="live_right_history" id="live_right_history">
              <ul class="live_right_message_edit_ul" id="live_msg_history">

              </ul>
            </div>
            <div class="live_right_message_edit clearfix" id="live_right_message_edit">
              <textarea class="message_edit" placeholder ="Type your message" rows="1" id="live_msg_edit"></textarea>

              <button class="send_btn" id="send_btn">Send</button>
            </div>
        </div>
    </div>
    <!--Movable Component End-->

    <!--All Js Here-->
    
	<!--Jquery 1.12.4-->
	<script src="../static/js/vendor/jquery-1.12.4.min.js"></script>
	<!--Popper-->
	<script src="../static/js/popper.min.js"></script>
	<!--Bootstrap-->
	<script src="../static/js/bootstrap.min.js"></script>
	<!--Imagesloaded-->
	<script src="../static/js/imagesloaded.pkgd.min.js"></script>
	<!--Isotope-->
	<script src="../static/js/isotope.pkgd.min.js"></script>
	<!--Waypoints-->
	<script src="../static/js/waypoints.min.js"></script>
	<!--Counterup-->
	<script src="../static/js/jquery.counterup.min.js"></script>
	<!--Carousel-->
	<script src="../static/js/owl.carousel.min.js"></script>
	<!--Slick-->
	<script src="../static/js/slick.min.js"></script>
	<!--Meanmenu-->
	<script src="../static/js/jquery.meanmenu.min.js"></script>
	<!--Easyzoom-->
	<script src="../static/js/easyzoom.min.js"></script>
	<!--Nice Select-->
	<script src="../static/js/jquery.nice-select.min.js"></script>
	<!--ScrollUp-->
	<script src="../static/js/jquery.scrollUp.min.js"></script>
	<!--Wow-->
	<script src="../static/js/wow.min.js"></script>
	<!--Venobox-->
	<script src="../static/js/venobox.min.js"></script>
	<!--Jquery Ui-->
	<script src="../static/js/jquery-ui.js"></script>
	<!--Countdown-->
	<script src="../static/js/jquery.countdown.min.js"></script>
	<!--Plugins-->
	<script src="../static/js/plugins.js"></script>
	<!--Main Js-->
	<script src="../static/js/main.js"></script>
    <!--Live stream Js-->
    <script src="../static/js/bootstrap.bundle.min.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/socket.io/3.1.2/socket.io.js"></script>

    <script>
        $(document).ready(function(){
            $('#searchinput').on('click', function (){
                const search = $('#content').val();
                $('#searchselect').val(search);
                $('#basepass').click();
            });
        });

        // loading animation between pages
        $(window).on("load",function(){
          $(".loader-wrapper").fadeOut("fast");
        });

        let ss = setTimeout(function(){
            clearTimeout(ss);
            $(".loader-wrapper").fadeOut("fast");
        },3500); // if the site fails to load in 4s, the loading animation will end still.

        // language selection
        $("#alternative-language").on('click', function (){

            let language = $(this).text();
            $.post("{{ url_for('main.change_language') }}", {'language': language },function () {
                location.reload(true);
            });
        })
    </script>

    <script>
        $(document).ready(function () {
            var is_adapted = false;

            // adaptation
            if (window.innerWidth < 750 && !is_adapted) {
                let el = document.getElementById("liveroom");
                el.style.width = '480px';
                el.style.height = '800px';
                let live_right = document.getElementById("live_right");
                live_right.style.float = "none";
                live_right.style.width = "480px";
                let live_right_top = document.getElementById("live_right_top");
                live_right_top.style.width = "480px";
                let live_right_history = document.getElementById("live_right_history");
                live_right_history.style.width = "480px";
                let live_right_message_edit = document.getElementById("live_right_message_edit")
                live_right_message_edit.style.width = "480px";

                let alpha_h = window.innerHeight / 800;
                let alpha_w = window.innerWidth / 480;
                let alpha = alpha_h > alpha_w ? alpha_w:alpha_h;
                el.style.transform = "scale("+alpha.toString()+")";
                is_adapted = true;

                el.style.top = String((window.innerHeight-800)/2) + 'px';
                el.style.left = String((window.innerWidth-480)/2) + 'px';
            }
            // create Agora client
            var client = null;
            var localTracks = {
                videoTrack: null,
                audioTrack: null
            };
            var remoteUsers = {};

            // Agora client options
            var options = {
                appid: "",
                channel: "",
                uid: null,
                token: "",
                role: "audience", // host or audience
                audienceLatency: 1
            };

            // global variable
            var is_liveroom_opened = false;
            var socket = null;
            var user_name = "user";

            $("#open_liveroom").on('click', async function(){
                {% if not current_user.is_authenticated %}
                    window.location.href = "{{ url_for("auth.login") }}";
                {% endif %}

                if (is_liveroom_opened){
                    await leave();
                    document.getElementById('liveroom').style.visibility = "hidden";
                    is_liveroom_opened = false;

                    if (socket){
                         socket.emit("leave", {room: "liveroom", user: user_name});
                    }
                } else {
                    document.getElementById('liveroom').style.visibility = "visible";
                    is_liveroom_opened = true;

                    socket = io.connect(
                        'https://' + document.domain + ':' + location.port + '/liveroom',
                        {
                              'reconnection': true,
                              'reconnectionAttempts': 8,
                              'reconnectionDelay': 1000}
                   );

                   // join comment channel
                   user_name = "{{ current_user.username }}";
                   socket.emit('join', {room: "liveroom", user: user_name, role: "customer"});

                   // receive message
                   socket.on('msg_response', function(data) {
                      var msg = data.msg;
                      if (msg !== '') {
                        if (data.user === user_name) {
                            $('#live_msg_edit').val("");
                        }
                        if (data.user === "Music Zone 2022") {
                            var msg_html = `<li class="msg_li"><div class="msg_li_in">
                                                <span class="msg_admin">${data.user}:</span>
                                                <span class="msg_content">${data.msg}</span>
                                            </div></li>`;
                        } else {
                            var msg_html = `<li class="msg_li"><div class="msg_li_in">
                                                <span class="msg_user">${data.user}:</span>
                                                <span class="msg_content">${data.msg}</span>
                                            </div></li>`;
                        }
                        $('#live_msg_history').append(msg_html);
                        scrollToBottom();
                      }
                   });

                   // token message
                   socket.on('token_response', async function (data) {
                       if (data.user === "{{ current_user.username }}") {
                           options.token = data.token;
                           options.uid = data.uid;
                           options.appid = data.appid;
                           options.channel = data.channel;
                           client = AgoraRTC.createClient({mode: "live", codec: "vp8"});
                           await join();
                       }
                   })

                   // request agora token
                   socket.emit('request_token', {user: user_name, role: "customer"});
                }
            });

            $('#leave_live').on('click', async function () {
                await leave();
                document.getElementById('liveroom').style.visibility = "hidden";
                is_liveroom_opened = false;

                if (socket){
                     socket.emit("leave", {room: "liveroom", user: user_name});
                }
            })

            $('#send_btn').on('click', function () {
                var msg = $('#live_msg_edit').val();
                // var msg_html = '<li class="msg_li"><div class="msg_user">' + user_name + ':</div><div class="msg_content">' + msg + '</div></li><br>';
                // $('#live_msg_history').append(msg_html);
                // scrollToBottom();
                if (msg !== ""){
                    socket.emit('send', {room: "liveroom", msg: msg, user: user_name});
                }
            })

            function scrollToBottom() {
                $('.live_right_history').scrollTop($('.live_right_history')[0].scrollHeight);
            }

            async function join() {
                // create Agora client

                if (options.role === "audience") {
                    client.setClientRole(options.role, {level: options.audienceLatency});
                    // add event listener to play remote tracks when remote user publishs.
                    client.on("user-published", handleUserPublished);
                    client.on("user-unpublished", handleUserUnpublished);
                }
                else{
                    client.setClientRole(options.role);
                }

                // join the channel
                options.uid = await client.join(options.appid, options.channel, options.token || null, options.uid || null)
            }

            async function leave() {
                for (trackName in localTracks) {
                    var track = localTracks[trackName];
                    if (track) {
                        track.stop();
                        track.close();
                        localTracks[trackName] = undefined;
                    }
                }

                // remove remote users and player views
                remoteUsers = {};
                $("#stream").html("");

                // leave the channel
                await client.leave();
            }

            async function subscribe(user, mediaType) {
                const uid = user.uid;
                // subscribe to a remote user
                await client.subscribe(user, mediaType);
                console.log("subscribe success");
                if (mediaType === 'video') {
                    const player = $(`
                    <div id="player-wrapper-${uid}">
                        <div id="player-${uid}" class="player"></div>
                    </div>
                    `);
                    $("#stream").append(player);
                    user.videoTrack.play(`player-${uid}`, {fit:"contain"});
                }
                if (mediaType === 'audio') {
                    user.audioTrack.play();
                }
            }

            function handleUserPublished(user, mediaType) {
                const id = user.uid;
                remoteUsers[id] = user;
                subscribe(user, mediaType);
            }

            function handleUserUnpublished(user, mediaType) {
                if (mediaType === 'video') {
                    const id = user.uid;
                    delete remoteUsers[id];
                    $(`#player-wrapper-${id}`).remove();
                }
            }
        })

        $(() => {
            let el = document.getElementById("liveroom");
            el.onmousedown = (e) => {
                let disX = e.clientX - el.offsetLeft;
                let disY = e.clientY - el.offsetTop;
                document.onmousemove = function (e) {
                    let tX = e.clientX - disX;
                    let tY = e.clientY - disY;

                    if (tX >= 0 && tX <= window.innerWidth - el.offsetWidth) {
                    el.style.left = tX + 'px';
                    }
                    if (tY >= 0 && tY <= window.innerHeight - el.offsetHeight) {
                    el.style.top = tY + 'px';
                    }
                };
                document.onmouseup = function (e) {
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            }
        })
    </script>
</body>
</html>